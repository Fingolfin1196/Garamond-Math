\RequirePackage{expl3}
\ProvidesExplPackage{xfonttable}{2018/3/19}{0.1}{Print font table with Unicode encodings and OpenType fonts}

\RequirePackage{xparse,array,longtable,multirow,hhline,amsmath}
\RequirePackage[table]{xcolor}
\RequirePackage{xcolor-material}

\definecolor { symbol   @ bg } { named } { white       } % { HTML } { FAFAFA }
\definecolor { encoding @ bg } { named } { lightgray   } % { HTML } { BDBDBD }
\definecolor { nochar   @ bg } { named } { GoogleGreen }
\definecolor { reserved @ bg } { named } { GoogleRed   }
\definecolor { control  @ bg } { named } { GoogleBlue  }

\file_input:n { unicode-reserved.def }
\file_input:n { unicode-control.def  }

\cs_new_protected:Npn \xfonttable_symbol:n #1
  { \tex_char:D \int_eval:n {#1} \scan_stop: }
\prg_new_protected_conditional:Npnn \xfonttable_if_char_exist:n #1 { T, F, TF }
  {
    \etex_iffontchar:D \tex_font:D \int_eval:n {#1} \scan_stop:
      \prg_return_true:
    \else:
      \prg_return_false:
    \fi:
  }

\newcounter { glyph }
\setcounter { glyph } { -1 }

\int_new:N \g__xfonttable_glyph_int
\int_new:N \g__xfonttable_code_point_int

\tl_new:N \l__xfonttable_tmpa_tl

\cs_new_protected:Npn \xfonttable_glyph:n #1
  {
    \tl_set:Nx \l__xfonttable_tmpa_tl { \int_to_Hex:n {#1} }
    \clist_if_in:NVTF \c__xfonttable_unicode_reserved_clist \l__xfonttable_tmpa_tl
      { \cellcolor { reserved@bg } }
      {
        \clist_if_in:NVTF \c__xfonttable_unicode_control_clist \l__xfonttable_tmpa_tl
          { \cellcolor { control@bg } }
          {
            \SYMBOLFONT
            \xfonttable_if_char_exist:nTF {#1}
              {
                \cellcolor { symbol@bg }
                \Large
                \xfonttable_symbol:n {#1}
                \refstepcounter { glyph }
                \int_gincr:N \g__xfonttable_glyph_int
              }
              { \cellcolor { nochar@bg } }
            \int_gincr:N \g__xfonttable_code_point_int
          }
      }
  }
\cs_new_protected:Npn \xfonttable_glyph_with_alignment:n #1
  { \xfonttable_glyph:n {#1} & }

\cs_new_protected:Npn \xfonttable_encoding:n #1
  {
    \group_begin:
      \cellcolor { encoding@bg }
      \ttfamily \tiny
      \int_compare:nNnTF {#1} < { "100 }
        { 00 }
        {
          \int_compare:nNnT {#1} < { "1000 }
          { 0 }
        }
      \int_to_Hex:n {#1}
    \group_end:
  }
\cs_new_protected:Npn \xfonttable_encoding_with_alignment:n #1
  { \xfonttable_encoding:n {#1} & }

\box_new:N \l__xfonttable_tmpa_box
\box_new:N \l__xfonttable_old_arstrut_box

\cs_new:Npn \xfonttable_set_arstrut:nn #1#2
  {
    \tex_noalign:D
      {
        \group_begin:
          % Store the old strutbox
          \box_gset_eq:NN \l__xfonttable_old_arstrut_box \@arstrutbox
          % Change the dimensions of \@arstrutbox
          \hbox_set_to_wd:Nnn \l__xfonttable_tmpa_box { \c_zero_dim } { }
          \box_set_ht:Nn \l__xfonttable_tmpa_box {#1}
          \box_set_dp:Nn \l__xfonttable_tmpa_box {#2}
          \hbox_gset:Nn \@arstrutbox { \box_use:N \l__xfonttable_tmpa_box }
        \group_end:
      }
  }
\cs_new:Npn \xfonttable_restore_arstrut:
  {
    \tex_noalign:D
      { \box_gset_eq:NN \@arstrutbox \l__xfonttable_old_arstrut_box }
  }

\int_new:N \l__xfonttable_tmpa_int
\cs_new:Npn \xfonttable_row_nummber:n #1
  {
    \raisebox { 20pt }
      {
        \ttfamily \footnotesize
        \int_set:Nn \l__xfonttable_tmpa_int { #1 / 16 }
        \int_compare:nNnTF { \l__xfonttable_tmpa_int } < { "10 }
          { 00 }
          {
            \int_compare:nNnT { \l__xfonttable_tmpa_int } < { "100 }
            { 0 }
          }
        \int_to_Hex:n { \l__xfonttable_tmpa_int }
        \skip_horizontal:n { 6pt }
      }
  }

\group_begin:
  \char_set_catcode_active:N \~
  \cs_new:Npn \xfonttable_hline:
    { \hhline { ~ | *{16}{-} } }
\group_end:

\cs_new:Npn \xfonttable_row:n #1
  {
    % Symbol row
    \xfonttable_hline:
    \xfonttable_set_arstrut:nn { 20pt } { 10pt }
    % Row number
    \multirow { 2 } * { \xfonttable_row_nummber:n {#1} } &
    \int_step_function:nnnN {#1} { 1 } { #1 + 14 }
      \xfonttable_glyph_with_alignment:n
    \xfonttable_glyph:n { #1 + 15 } \\
    \xfonttable_restore_arstrut:
    % Encoding row
    \xfonttable_hline:
    \xfonttable_set_arstrut:nn { 5pt } { 1pt } &
    \int_step_function:nnnN {#1} { 1 } { #1 + 14 }
      \xfonttable_encoding_with_alignment:n
    \xfonttable_encoding:n { #1 + 15 } \\
  }

\cs_new:Npn \xfonttable_multi_row:nn #1#2
  {
    \int_step_function:nnnN
      { \__xfonttable_div_sixteen:n {#1} * 16 }
      { 16 }
      { (\__xfonttable_div_sixteen:n {#2} + 1) * 16 - 1 }
      \xfonttable_row:n
  }

\cs_new:Npn \__xfonttable_div_sixteen:n #1
  { \int_div_truncate:nn {#1} { 16 } }

\cs_new:Npn \xfonttable_first_row_cell:n #1
  {
    \group_begin:
      \ttfamily \footnotesize
      \int_to_Hex:n {#1}
    \group_end:
  }
\cs_new:Npn \xfonttable_first_row_cell_with_alignment:n #1
  { \xfonttable_first_row_cell:n {#1} & }
\cs_new:Npn \xfonttable_first_row:
  {
    \int_step_function:nnnN { 0 } { 1 } { 14 }
      \xfonttable_first_row_cell_with_alignment:n
    \xfonttable_first_row_cell:n { 15 }
  }

\newcolumntype {C} [1] { >{\centering\arraybackslash} m {#1} }

\dim_new:N  \l__xfonttable_cell_wd_dim
\dim_new:N  \l__xfonttable_column_sep_dim
\dim_set:Nn \l__xfonttable_cell_wd_dim    { 30 pt }
\dim_set:Nn \l__xfonttable_column_sep_dim {  0 pt }

\cs_new_protected:Npn \xfonttable_make_table:nn #1#2
  {
    \longtable { r | *{16}{ C{ \l__xfonttable_cell_wd_dim } | } }
      &
      \multicolumn {16} { @{} c @{} | }
        {
          \tabular { * {16} { C{ \l__xfonttable_cell_wd_dim } } }
            \xfonttable_first_row:
          \endtabular
        }
      \\
      \xfonttable_multi_row:nn {#1} {#2}
      \xfonttable_hline:
    \endlongtable
  }

\tl_new:N \l__xfonttable_glyph_count_tl

\NewDocumentCommand \fonttable { m m m o }
  {
    \tl_set:Nn \l__xfonttable_glyph_count_tl
      { \ref*{count:glyph@#1} / \ref*{count:codepoint@#1} }
    \section{#1 ~ (\tl_use:N \l__xfonttable_glyph_count_tl)}
    \int_gzero:N \g__xfonttable_glyph_int
    \int_gzero:N \g__xfonttable_code_point_int
    \xfonttable_make_table:nn {#2} {#3}
    \newcounter     {    glyph     @ #1 }
    \newcounter     {    codepoint @ #1 }
    \int_set:cn     { c@ glyph     @ #1 } { \g__xfonttable_glyph_int      - 1 }
    \int_set:cn     { c@ codepoint @ #1 } { \g__xfonttable_code_point_int - 1 }
    \refstepcounter {    glyph     @ #1 } \label{count:glyph@#1}
    \refstepcounter {    codepoint @ #1 } \label{count:codepoint@#1}
    \IfValueT {#4} {#4}
    \clearpage
  }

\dim_set_eq:NN \tabcolsep \l__xfonttable_column_sep_dim
